document.onkeydown=register;dragController.init();popupController.init();scrollController.init();a=new dragDropSource('catalog_links_container','LI',false);a.triggerElementClassName="box_draggable";a.yStep=5;dragController.addSource('catalog_links_container',a);a.onUpdate=function(){util.showElement(util.getElement('saveCatalogLinksOrder'))};a=new dragDropSource('shop_products_container','LI',false);a.triggerElementClassName="box_draggable";a.yStep=5;dragController.addSource('shop_products_container',a);a.onUpdate=function(){util.showElement(util.getElement('saveShopProductOrder'))};a=new dragDropSource('file_container','LI',false);a.triggerElementClassName="box_draggable";a.yStep=5;dragController.addSource('file_container',a);a.onUpdate=function(){util.showElement(util.getElement('saveFileOrder'))};a=new dragDropSource('texts_container','LI',false);a.yStep=5;a.triggerElementClassName="box_draggable";dragController.addSource('texts_container',a);a.onUpdate=function(){util.showElement(util.getElement('saveTextOrder'))};a=new dragDropSource('selected_container','LI',false);dragController.addSource('selected_container',a);a=new dragDropSource('selected_container_tr','TR',false);dragController.addSource('selected_container_tr',a);a=new dragDropSource('form_layout','DIV',false);a.yStep=5;a.triggerElementClassName="anketa_control";a.emptyClassName="anketa_empty";a.onUpdate=function(){util.showElement(util.getElement('saveAnketaOrder'))};dragController.addSource('form_layout',a);a=new dragDropSource('flash_list_container','LI',false);a.triggerElementClassName="box_draggable";a.yStep=5;dragController.addSource('flash_list_container',a);a.onUpdate=function(){util.showElement(util.getElement('saveFlashOrder'))};a=new dragDropSource('folder-draggable-root','DIV',true);a.branchClassName="folderBranch";a.branchCollapsedClassName="folderBranch-collapsed";a.branchEndClassName="folderBranch-end";a.branchExpandedClassName="folderBranch-expanded";a.emptyClassName="tree-empty";a.onUpdate=folderStorage.onUpdate;a.scrollContainer="folder_scroll_div";a.triggerElementTagName="IMG";a.xStep=2;a.yStep=2;dragController.addSource('folder-draggable-root',a);a=new dragDropSource('control-multi-file','LI',false);a.yStep=5;a.triggerElementClassName="box_draggable";dragController.addSource('control-multi-file',a);a=new dragDropSource('control-multi-flash','LI',false);a.yStep=5;a.triggerElementClassName="box_draggable";dragController.addSource('control-multi-flash',a);a=new dragDropSource('control-multi-image','LI',false);a.triggerElementClassName="draggable";a.triggerElementTagName="TD";dragController.addSource('control-multi-image',a);a=new dragDropSource('^gallery2_albums_dragable','LI',false);dragController.addSource('^gallery2_albums_dragable',a);a.triggerElementTagName="TD";a.onUpdate=function(){$('[id=saveGalleryAlbumsOrder]:last').show()};var a=new dragDropSource('^gallery2_images_container_dragable','LI',false);dragController.addSource('^gallery2_images_container_dragable',a);a.triggerElementTagName="TD";a.onUpdate=function(dragged_alement){var gallery_id=$("[name=album_id]:last").val();var album_id=$("[name=album_id]:last").val();if(album_id>0){var before_el=$(dragged_alement).prev();var after_el=$(dragged_alement).next();var before=0;var after=0;var c_id=$(dragged_alement).attr('id').match(/\d+/);var current=c_id&&c_id.length?c_id[0]:0;if(before_el.length){var b_id=before_el.attr('id').match(/\d+/);before=b_id&&b_id.length?b_id[0]:0}if(after_el.length){var a_id=after_el.attr('id').match(/\d+/);after=a_id&&a_id.length?a_id[0]:0}if(current&&(before||after)){$.post('/-/cms/v1/gallery2/?act=view&object_id='+gallery_id+'&album_id='+album_id+"&"+access,{'before':before,'after':after,'current':current})}}};a=new dragDropSource('shop2-block-products','LI',false);dragController.addSource('shop2-block-products',a);a=new dragDropSource('article-list-block','LI',false);dragController.addSource('article-list-block',a);$(document).on('mouseover','.gallery2-images__sortable',function(){$(this).removeClass('gallery2-images__sortable').sortable({cursor:"move",placeholder:"gallery__image-placeholder",items:'li:not(.controls), >tr:not(.controls)',connectWith:".gallery2-images__list",handle:".image-zoom",}).on("sortupdate",function(event,ui){var gallery_id=$(event.currentTarget).data('gallery-id'),folder_id=$(event.currentTarget).data('folder-id');if(folder_id>0){var before_el=$(ui.item).prev();var after_el=$(ui.item).next();var before=0;var after=0;var c_id=$(ui.item).attr('id').match(/\d+/);var current=c_id&&c_id.length?c_id[0]:0;if(before_el.length){var b_id=before_el.attr('id').match(/\d+/);before=b_id&&b_id.length?b_id[0]:0}if(after_el.length){var a_id=after_el.attr('id').match(/\d+/);after=a_id&&a_id.length?a_id[0]:0}if(current&&(before||after)){$.post('/-/cms/v1/gallery2/?act=view&object_id='+gallery_id+'&folder_id='+folder_id+"&"+access,{'before':before,'after':after,'current':current}).done(function(data){util.msg(s3.loc('JS_SAVED'))})}}})});$(document).on('mouseover','.s3_shop_sortable_items',function(){$(this).removeClass('s3_shop_sortable_items').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",items:'li:not(.controls), >tr:not(.controls)'}).on("sortstart",function(event,ui){if($(event.currentTarget).find('>tr').length){ui.placeholder.html('<td colspan="7">&nbsp;</td>')}}).on("sortupdate",function(event,ui){var pattern=/^(shop2_product_)|(shop2_vendor_)|(shop_product_)/;var pattern_shop2_product=/^(shop2_product_)/;var pattern_shop2_vendor=/^(shop2_vendor_)/;var pattern_shop_product=/^(shop_product_)/;var current_sorted_id=parseInt(ui.item.attr('id').replace(pattern,''));var before=$(ui.item).prev().attr('id');before=(before!=undefined)?before.replace(pattern,''):null;var after=$(ui.item).next().attr('id');after=(after!=undefined)?after.replace(pattern,''):null;var site_u="ver_id="+$("[name=ver_id]").val()+"&access="+$("[name=access]").val();var shop_id=$("[name=shop_id]").val();var folder_id=treeController.current_folder_id;if(pattern_shop2_product.test(ui.item.attr('id'))){Preloader.show({new_preloader:true});$.post('/-/cms/v1/shop2/?act=view&'+site_u+'&object_id='+shop_id,{'before':before,'after':after,'current_sorted_id':current_sorted_id,'folder_id':folder_id}).done(function(data){setTimeout(function(){Preloader.hide();util.msg(s3.loc('JS_SAVED'))},1000)}).fail(function(data){s3.alertHTML(s3.loc('JS_POSITIONS_CHANGED'))})}else if(pattern_shop2_vendor.test(ui.item.attr('id'))){$.post('/-/cms/v1/shop2/vendor/?'+site_u+'&shop_id='+shop_id,{'before':before,'after':after,'current_sorted_id':current_sorted_id})}else if(pattern_shop_product.test(ui.item.attr('id'))){Preloader.show({new_preloader:true});$.post('/-/cms/v1/shop/?act=view&'+site_u+'&object_id='+shop_id,{'before':before,'after':after,'current_sorted_id':current_sorted_id}).done(function(data){setTimeout(function(){Preloader.hide();util.msg(s3.loc('JS_SAVED'))},1000)}).fail(function(data){s3.alertHTML(s3.loc('JS_POSITIONS_CHANGED'))})}})});$(document).on('mouseover','.s3_fast_pay_sortable_items',function(){$(this).removeClass('s3_fast_pay_sortable_items').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",items:'tr:not(.controls)',handle:".handle"}).on("sortupdate",function(event,ui){var pattern=/^fast_pay_service_/;var current_sorted_id=parseInt(ui.item.attr('id').replace(pattern,''));var before=$(ui.item).prev().attr('id');before=(before!=undefined)?before.replace(pattern,''):null;var after=$(ui.item).next().attr('id');after=(after!=undefined)?after.replace(pattern,''):null;var fast_pay_id=$(ui.item).data('fast-pay-id');$.post('/-/cms/v1/fast-pay/?act=sort_service&'+access+'&fast_pay_id='+fast_pay_id,{'before':before,'after':after,'current_sorted_id':current_sorted_id})})});$(document).on('mouseover','.collections-set-products-sortable',function(){$(this).removeClass('collections-set-products-sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",items:'a.shop2-collect-product',helper:'clone'}).on("sortupdate",function(event,ui){var sorted_ids=ui.item.attr("data-object-id");var sorted_position=$(this).sortable('toArray',{attribute:'data-object-id'});var collect_id=$(ui.item).data('collect-id');$.post('/-/cms/v1/shop2/collect/?act=sort&'+S3_ACCESS,{'sorted_ids':sorted_ids,'sorted_position':sorted_position,'collect_id':collect_id},function(){util.msg(JS_SAVED)})})});$(document).on('mouseover','.collections-set-folders-sortable',function(){$(this).removeClass('collections-set-folders-sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",items:'a.shop2-collect-folder',helper:'clone'}).on("sortupdate",function(event,ui){var sorted_ids=ui.item.attr("data-folder-id");var sorted_position=$(this).sortable('toArray',{attribute:'data-folder-id'});var collect_id=$(ui.item).data('collect-id');$.post('/-/cms/v1/shop2/collect/?act=sort&'+S3_ACCESS,{'sorted_ids':sorted_ids,'sorted_position':sorted_position,'collect_id':collect_id},function(){util.msg(JS_SAVED)})})});if(typeof RegExp.quote!="function"){RegExp.quote=function(str){return str.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}}$(document).on('mouseover','.json_sortable',function(){$(this).removeClass('json_sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle',items:"li:not(.controls)"}).on("sortupdate",function(event,ui){if(!$(ui.item).attr('id')||!$(this).attr('class'))return;var object_id=$(ui.item).attr('id').match(/\d+/);var query_id=$(this).attr('class').match(/\d+/);if(!(object_id&&query_id&&object_id.length&&query_id.length)){return}object_id=object_id[0];query_id=query_id[0];var before_element=$(ui.item).prev();var id_before=0;var after_element=$(ui.item).next();var id_after=0;if(before_element.length&&before_element.attr('id')){id_before=before_element.attr('id').match(/\d+/)[0]}if(after_element.length&&after_element.attr('id')){id_after=after_element.attr('id').match(/\d+/)[0]}$.post('/-/cms/v1/json/?act=move&'+access+'&object_id='+object_id+'&group_id='+query_id,{id_before:id_before,id_after:id_after})})});$(document).on('mouseover','.delivery_sortable',function(){$(this).removeClass('delivery_sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle',items:"li:not(.controls)"}).on("sortupdate",function(event,ui){var sorted_ids=ui.item.attr("setting-id");var sorted_position=$(this).sortable('toArray',{attribute:'setting-id'});$.post('/-/cms/v1/shop2/delivery/?'+S3_ACCESS+'&act=delivery_sort',{'sorted_ids':sorted_ids,'sorted_position':sorted_position},function(){util.msg(JS_SAVED)})})});$(document).on('mouseover','.template_sortable',function(){$(this).removeClass('template_sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",tolerance:"pointer",handle:'.handle',items:"a:not(.controls), li:not(.controls)"}).on("sortupdate",function(event,ui){var pattern=/^tpl_data_/;var page_id=$(this).data('page-id');var current_sorted_id=parseInt(ui.item.attr('id').replace(pattern,''));var before=$(ui.item).prev().attr('id');before=(before!=undefined)?before.replace(pattern,''):null;var after=$(ui.item).next().attr('id');after=(after!=undefined)?after.replace(pattern,''):null;$.post('/-/cms/v1/page/?act=edit&'+access+'&page_id='+page_id,{'before':before,'after':after,'current_sorted_id':current_sorted_id},function(){util.msg(JS_SAVED)})})});$(document).on('mouseover','.lp_layout_sortable',function(){$(this).removeClass('lp_layout_sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle',items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var form=$(ui.item).closest('form');LpController.updatePresetDefaultBlocks(form)})});$(document).on('mouseover','.lp_layout_list_sortable',function(){if($(this).hasClass('ui-sortable')){return}$(this).sortable({cursor:"move",placeholder:"lp_layout_list_sortable_sortable_placeholder",handle:'.layout-item__sortable-handler',items:'div.layout-item:not(.deprecated):not(.local)'}).on("sortupdate",function(event,ui){const folderIdPreset=$(ui.item).data('folder_id_preset');if(folderIdPreset){LpController.saveFolderLayoutsOrder(folderIdPreset,$('.landing-page-layout-list'))}})});$(document).on('mouseover','.template-library-sortable',function(){if($(this).hasClass('ui-sortable')){return}$(this).sortable({cursor:"move",placeholder:"template-library__card--placeholder",items:'.template-library__card'}).on("sortupdate",function(event,ui){const current=$(ui.item);const previous=$(ui.item).prev();const next=$(ui.item).next();const $templateWrapper=$(ui.item).parent();const groupId=$templateWrapper.data('group-id');const data={template_group_id:parseInt(groupId),previous:previous&&previous.data('template-id')!==undefined?{template_id:parseInt(previous.data('template-id')),template_preset_id:parseInt(previous.data('template-preset-id')),}:undefined,current:{template_id:parseInt(current.data('template-id')),template_preset_id:parseInt(current.data('template-preset-id')),},next:next&&next.data('template-id')!==undefined?{template_id:parseInt(next.data('template-id')),template_preset_id:parseInt(next.data('template-preset-id')),}:undefined,};$.post('/-/cms/v1/template/library/?act=sort&'+access,data).done(function(){util.msg(s3.loc('JS_SAVED'))}).fail(function(){s3.alert(s3.loc('JS_ERROR'),function(){s3.reloadVisibleContent()})})})});$(document).on('mouseover','.image_sortable',function(){$(this).removeClass('image_sortable').sortable({cursor:"move",items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var pattern=/^(image)/;var current_sorted_id=parseInt(ui.item.attr('id').replace(pattern,''));var before=$(ui.item).prev().attr('id');before=(before!=undefined)?before.replace(pattern,''):null;var after=$(ui.item).next().attr('id');after=(after!=undefined)?after.replace(pattern,''):null;$.post('/-/cms/v1/image/?act=reorder&'+access,{'before':before,'after':after,'current_sorted_id':current_sorted_id,'folder_id':treeController.current_folder_id})})});$(document).on('mouseover','.gallery-sortable',function(){$(this).removeClass('gallery-sortable').sortable({cursor:"move",placeholder:"s3-sortable-placeholder",handle:'.image-draggable',items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var gallery_id=parseInt($("[name=gallery_id]").val());if(gallery_id>0){var pattern=/^(gallery_image_)/;var current_sorted_id=parseInt(ui.item.attr('id').replace(pattern,''));var before=$(ui.item).prev().attr('id');before=(before!=undefined)?before.replace(pattern,''):null;var after=$(ui.item).next().attr('id');after=(after!=undefined)?after.replace(pattern,''):null;if(current_sorted_id&&(before||after)){$.post('/-/cms/v1/gallery/?act=view&object_id='+gallery_id+"&"+access,{'before':before,'after':after,'current':current_sorted_id})}}})});$(document).on('mouseover','.media_list_sortable',function(){$(this).removeClass('media_list_sortable').sortable({cursor:"move",items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var ul=$(ui.item).parent(),ulId=ul.attr('id'),url='/-/cms/v1/folder/?act=reorder_items&'+S3_ACCESS+'&folder_id='+treeController.current_folder_id,result=s3.getElementsOrder(ulId,'LI','media');if(result.ids.length>0){var data="ids="+encodeURIComponent(result.ids.join())+"&levels="+encodeURIComponent(result.levels.join());var r=util.makePostRequest(url,data);if(r.error){util.msg("Error");return false}}util.msg(s3.loc('JS_SAVED'))})});$(document).on('mouseover','.form_group_sortable',function(){$(this).removeClass('form_group_sortable').sortable({cursor:"move",items:'.form-group'}).on("sortupdate",function(event,ui){var sorted_ids=ui.item.attr("setting-id");var sorted_position=$(this).sortable('toArray',{attribute:'setting-id'});$.post('/-/cms/v1/anketa2/?act=change_position_group&'+S3_ACCESS,{'sorted_ids':sorted_ids,'sorted_position':sorted_position},function(){util.msg(JS_SAVED)})})});$(document).on('mouseover','.album_sortable',function(){$(this).removeClass('album_sortable').sortable({cursor:"move",items:'li:not(.controls)',helper:'clone'}).on("sortupdate",function(event,ui){var ul=$(ui.item).parent(),ulId=ul.attr('id'),galleryId=ul.data('gallery-id'),url='/-/cms/v1/gallery2/?act=sort&'+S3_ACCESS+'&gallery_id='+galleryId,result=s3.getElementsOrder(ulId,'LI','gallery_album_');if(result.ids.length>0){var data="ids="+encodeURIComponent(result.ids.join())+"&levels="+encodeURIComponent(result.levels.join());var r=util.makePostRequest(url,data);if(r.error){util.msg("Error");return false}}util.msg(s3.loc('JS_SAVED'))})});$(document).on('mouseover','.form_sortable',function(){$(this).removeClass('form_sortable').sortable({cursor:"move",items:'.anketa_control',helper:'clone',cancel:'span.control-controls'}).on("sortupdate",function(event,ui){var result=s3.getElementsOrder('form_layout','DIV','control_'),url='/-/cms/v1/anketa/?act=reorder_controls&ver_id='+FormController.ver_id+S3_ACCESS+'&anketa_id='+FormController.anketa_id;if(result.ids.length>0){var data="ids="+encodeURIComponent(result.ids.join())+"&levels="+encodeURIComponent(result.levels.join());var r=util.makePostRequest(url,data);if(r.error){util.msg("Error");return false}}util.msg(s3.loc('JS_SAVED'));return true})});$(document).on('mouseover','.article-recommended-sortable',function(){$(this).removeClass('.article-recommended-sortable').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",items:'li:not(.controls)'})});$(document).on('mouseover','.shop2-color-ref-elements:not(".shop2-color-ref-elements-not-sotred")',function(){$(this).removeClass('shop2-color-ref-elements').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle',items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var ref_id=$(ui.item).data('ref-id'),url='/-/cms/v1/shop2/reference/?act=sort&'+access+'&ref_id='+ref_id;s3.saveElementsOrder('shop2_color_ref_elements','shop2_save_color_ref_elements_order','LI','element_',url)})});$(document).on('mouseover','.shop2-ref-elements:not(".shop2-color-ref-elements-not-sotred")',function(){$(this).removeClass('shop2-ref-elements').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle',items:'li:not(.controls)'}).on("sortupdate",function(event,ui){var ref_id=$(ui.item).data('ref-id'),url='/-/cms/v1/shop2/reference/?act=sort&'+access+'&ref_id='+ref_id;s3.saveElementsOrder('shop2_ref_elements','saveRefElementsOrder','LI','element_',url)})});$(document).on('mouseover','.shop2-field-container',function(){$(this).removeClass('shop2-field-container').sortable({cursor:"move",placeholder:"s3_sortable_placeholder",handle:'.handle'})});(function(){var dropTarget='.image-drag-and-drop-message',html=$('html'),showDrag=false,timeout=-1;$(document).on('dragenter','.s3-image, .s3-files, .s3-media',function(e){e.stopPropagation();e.preventDefault();$(dropTarget).addClass('dragging');$(dropTarget).next().hide();showDrag=true});$(document).on('dragover','.s3-image, .s3-files, .s3-media',function(e){e.stopPropagation();e.preventDefault();$(dropTarget).addClass('dragging');$(dropTarget).next().hide();showDrag=true;setTimeout(function(){$(dropTarget).addClass('animate')},1)});html.on('dragleave',function(e){e.stopPropagation();e.preventDefault();showDrag=false;clearTimeout(timeout);timeout=setTimeout(function(){if(!showDrag){$(dropTarget).removeClass('animate');$(dropTarget).removeClass('dragging');$(dropTarget).next().show()}},200)});$(document).on('drop',dropTarget,function(evt){evt.stopPropagation();evt.preventDefault();var moduleType=$(evt.currentTarget).data('type'),tree=$('.tree-wrapper'),node,type,type_id,orderby,curr_folder_id;if(!tree.size()){return false};if(tree.find('.dynatree-node.active').size()>0){node=$.ui.dynatree.getNode(tree.find('.dynatree-node.active').last());if(node&&node.data){curr_folder_id=node.data.key}}else{node=$.ui.dynatree.getNode(tree.find('.dynatree-node').last())};if(!node||!node.data){return false};type=node.data.type;type_id=node.data.type_id;orderby=node.data.orderby;$(dropTarget).removeClass('dragging');$(dropTarget).removeClass('animate');$(dropTarget).next().show();var global=$(this).parents('.s3-image').attr('data-global')?1:0;var parent=popupController.getLastPopup()?popupController.getLastPopup().obj:this;var objId=$(this).parent().find('ul:first').attr('id');var dataTransfer=evt.originalEvent.dataTransfer;if(moduleType=='file'){uploader.uploadObject(null,'LI',objId,'/-/cms/v1/file/?act=edit&folder_id='+curr_folder_id+'&object_id=0&'+access+'&orderby='+orderby,'/-/cms/v1/file/?act=edit&upload_type=swfupload&orderby='+orderby+access,0,{ver_id:ver_id,upload_type:'swfupload',uploadParams:{drop:evt}})}else if(moduleType=='media'){uploader.uploadObject(null,'LI',objId,'/-/cms/v1/media/?act=edit&folder_id='+curr_folder_id+'&object_id=0&'+access+'&orderby='+orderby,'/-/cms/v1/media/?act=edit&upload_type=swfupload&'+access,0,{ver_id:ver_id,upload_type:'swfupload',uploadParams:{drop:evt}})}else{uploader.uploadImageObject(null,'LI',objId,'/-/cms/v1/image/?act=edit&folder_id='+treeController.current_folder_id+'&object_id=0&'+access+'&global='+global,'/-/cms/v1/image/?act=edit&upload_type=swfupload&orderby='+access,0,{ver_id:ver_id,upload_type:'swfupload',uploadParams:{drop:evt}})}})})();